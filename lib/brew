#!/bin/bash

run_brew() {
    # Check for Homebrew
    if type_exists 'brew'; then
        e_header "Updating Homebrew..."
        # Use the latest version of Homebrew
        brew update
        [[ $? ]] && e_success "Done"

        e_header "Updating any existing Homebrew formulae..."
        # Upgrade any already-installed formulae
        brew upgrade
        [[ $? ]] && e_success "Done"

        e_header "Homebrew taps"
        brew tap homebrew/dupes && \
        brew tap homebrew/versions && \
        brew tap homebrew/php && \
        brew tap homebrew/apache

        [[ $? ]] && e_success "Done"

        # disable macos apache before install
        sudo apachectl stop
        sudo launchctl unload -w /System/Library/LaunchDaemons/org.apache.httpd.plist 2>/dev/null

        if ! formula_exists httpd24; then
            brew install httpd24 --with-privileged-ports --with-http2
        fi

        e_header "Have launchd start homebrew/apache/httpd24 now and restart at startup"
        sudo brew services start homebrew/apache/httpd24
        [[ $? ]] && e_success "Done"

        # disable php70 to prevent collisions
        if formula_exists 'php70'; then
            brew unlink php70
        fi

        #switch from SecureTransport
        if $(brew info curl | grep with-openssl >/dev/null 2>&1); then
            e_success "curl with openssl support already installed."
        else
            e_header "reinstall curl with openssl support"
            brew reinstall --with-openssl curl
            [[ $? ]] && e_success "Done"
        fi

        e_header "Checking status of desired Homebrew formulae..."
        local list_formulae
        local -a missing_formulae
        local -a desired_formulae=(
            # GNU core utilities (those that come with OS X are outdated)
            'coreutils'
            'moreutils'
            'findutils'

            # git
            'git'
            'hub'
            'git-extras'
            'diff-so-fancy'

            # system
            'dnsmasq'
            'libmemcached'

            # shell
            'zsh'
            'bash'
            'bash-completion'
            'tree'
            'ack'
            'gnu-sed --default-names' # Install the GNU version of sed
            'wget --with-iri' # Install wget with IRI support
            'homebrew/dupes/grep'
            'homebrew/dupes/screen'
            'mtr' # mtr - ping & traceroute. best.

            # dev
            'php56 --with-apache --with-mysql --with-homebrew-curl --with-homebrew-openssl --without-snmp  --without-fpm'
            'php56-imagick'
            'php56-intl'
            'php56-xdebug'
            'php56-mcrypt'
            'php56-memcached'
            'php56-opcache'
            'php56-apcu'
            'python'
            'node'
            'yarn'
            'mariadb'
            'macvim --override-system-vim'
            'xdebug-osx'

            # tools
            'ssh-copy-id'
            'testssl'
            'rsync'
            'rename' # http://plasmasturm.org/code/rename/

            # media
            'ffmpeg --with-libvpx'
            'imagemagick --with-webp'
            'gifsicle'
            'graphicsmagick'
            'optipng'
            'zopfli'
            'jpeg'
            'youtube-dl'
        )

        for index in ${!desired_formulae[*]}
        do
            if ! formula_exists ${desired_formulae[$index]}; then
                # Store the name (and options) of every missing formula
                missing_formulae=("${missing_formulae[@]}" "${desired_formulae[$index]}")

                e_header "Installing missing Homebrew formulae ${desired_formulae[$index]}"
                brew install ${desired_formulae[$index]}
            fi
        done

        #php7
        if ! formula_exists 'php70'; then
            brew unlink php56
            brew install php70 --with-apache --with-mysql --with-homebrew-curl --with-homebrew-openssl --without-snmp --without-fpm
            brew install php70-imagick
            brew install php70-intl
            brew install php70-xdebug
            brew install php70-mcrypt
            brew install php70-opcache
            brew install php70-apcu
            # php7-memcached needs HEAD install
            brew install --HEAD homebrew/php/php70-memcached
        fi

        

        # use latest rsync rather than out-dated OS X rsync
        # install separately from the main formulae list to fix gh-19
        brew install https://raw.github.com/Homebrew/homebrew-dupes/master/rsync.rb

        # Remove outdated versions from the Cellar
        brew cleanup
    else
        printf "\n"
        e_error "Error: Homebrew not found."
        printf "Aborting...\n"
        exit
    fi

}